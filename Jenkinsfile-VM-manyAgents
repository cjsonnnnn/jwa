def remote = [:]
remote.name = 'vm-lab1'
remote.host = '192.168.18.21'
remote.allowAnyHosts = true

pipeline {
  agent any

  tools {
    jfrog 'jfrog-cli'
  }

  options {
    buildDiscarder(logRotator(numToKeepStr: '5'))
  }

  parameters {
    string(name: 'IMAGE_TAG', description: 'Docker image tag to deploy')
  }

  environment {
    DOCKERHUB_CREDENTIALS = credentials('dockerhub-jpiay')
    PI_CREDS = credentials('ssh-vm-lab1')
  }

  stages {
    stage('Build and Publish to Artifactory') {
      agent { label 'agent-maven' }
      steps {
        script {
          echo "ğŸ§ª Setting Maven version to ${params.IMAGE_TAG}"
          sh "mvn versions:set -DnewVersion=${params.IMAGE_TAG} -DgenerateBackupPoms=false"
        }

        // ğŸ”¨ Building JAR
        sh "mvn clean package"

        // ğŸ“„ Listing built files
        sh "ls -lh target/"

        // ğŸ“¦ Uploading to Artifactory
        jf "rt u target/demo-${params.IMAGE_TAG}.jar example-repo-local/target/ --flat=true"

        // ğŸ“ Publishing build info
        jf "rt bp"
      }
    }

    stage('Docker Build & Push') {
      agent { label 'agent-dind' }
      steps {
        // ğŸ“¥ Downloading from Artifactory
        jf "rt dl example-repo-local/target/demo-${params.IMAGE_TAG}.jar"

        // ğŸ¦† Renaming file
        sh "cp target/demo-${params.IMAGE_TAG}.jar app.jar"

        // ğŸ“„ Listing built files
        sh "ls -lh"

        // ğŸ”¨ Building Docker image
        sh "docker build -t jpiay/jwa:${params.IMAGE_TAG} ."

        // ğŸ” Docker login
        sh "echo \$DOCKERHUB_CREDENTIALS_PSW | docker login -u \$DOCKERHUB_CREDENTIALS_USR --password-stdin"

        // ğŸš€ Pushing Docker image to Docker Hub
        sh "docker push jpiay/jwa:${params.IMAGE_TAG}"
      }
    }

    stage('Deploy to Remote Server') {
      agent { label 'agent-dind' }
      steps {
        script {
          // ğŸ–¥ï¸ Deploying
          remote.user = env.PI_CREDS_USR
          remote.password = env.PI_CREDS_PSW

          sshCommand(remote: remote, command: """
            echo 'ğŸ“¦ Pulling Docker image jpiay/jwa:${params.IMAGE_TAG}'
            sudo docker pull jpiay/jwa:${params.IMAGE_TAG}

            echo 'ğŸ§¹ Stopping existing container if exists'
            sudo docker rm -f java-web-app || true

            echo 'ğŸš€ Starting new container'
            sudo docker run -d --name java-web-app -p 8090:8080 --restart unless-stopped jpiay/jwa:${params.IMAGE_TAG}
          """)
        }
      }
    }
  }

  post {
    always {
      script {
        // ğŸ§¹ Cleaning up Docker session and workspace
        sh "docker logout || true"
        sleep(5)
        cleanWs()
      }
    }
  }
}
